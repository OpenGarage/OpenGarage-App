angular.module("opengarage",["ionic","uiCropper","opengarage.controllers","opengarage.utils","opengarage.cloud","opengarage.watch"]).run(function($state,$ionicPlatform,$ionicScrollDelegate,$document,$window,$rootScope,$filter,$ionicLoading,$timeout,Utils,Cloud,Watch){$ionicPlatform.ready(function(){var handleGeofence;$rootScope.open=function(url){window.SafariViewController?window.SafariViewController.isAvailable(function(available){available?window.SafariViewController.show({url:url,tintColor:"#444444",barColor:"#444444",controlTintColor:"#ffffff"}):window.open(url,"_blank","toolbarposition=top")}):window.open(url,"_blank","toolbarposition=top")},window.cordova&&window.cordova.plugins&&window.cordova.plugins.Keyboard&&window.cordova.plugins.Keyboard.hideKeyboardAccessoryBar&&window.cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),window.StatusBar&&(window.StatusBar.styleLightContent(),window.StatusBar.backgroundColorByHexString("#444"),angular.element($window).on("statusTap",function(){$ionicScrollDelegate.scrollTop()})),window.geofence&&($rootScope.hasGeofence=!0,$rootScope.startGeofence=function(callback){window.geofence.initialize().then(function(){callback(!0)},function(){callback(!1)})},window.geofence.getWatched(function(fences){$rootScope.geoFences=JSON.parse(fences)}),handleGeofence=function(geofences){geofences&&(geofences.notification&&(geofences=[geofences]),$rootScope.$apply(function(){geofences.forEach(function(geo){var data=geo.notification.id.split("-"),controller=$filter("filter")($rootScope.controllers,{mac:data[1]});controller&&"open"===data[0]&&0===controller.door&&"close"===data[0]&&1===controller.door&&Utils.toggleDoor(controller.auth)})}))},window.geofence.onTransitionReceived=handleGeofence,window.geofence.onNotificationClicked=handleGeofence),window.ThreeDeeTouch&&(Utils.updateQuickLinks(),window.ThreeDeeTouch.enableLinkPreview(),window.ThreeDeeTouch.onHomeIconPressed=function(payload){var controller,data=payload.type.split("-");"toggle"!==data[0]||(controller=$filter("filter")($rootScope.controllers,{mac:data[1]}))&&Utils.toggleDoor(controller.auth)}),window.applewatch&&!0!==window.navigator.simulator&&(window.applewatch.init(angular.noop),window.toggleDoorByIndex=function(index){Utils.toggleDoor($rootScope.controllers[index].auth)},window.applewatch.callback.onLoadAppMainRequest=Watch.loadApp),$timeout(function(){try{navigator.splashscreen.hide()}catch(err){}},500)}),$rootScope.connected=!1,$rootScope.version=window.appVersion,$rootScope.loadingQueue=[],$rootScope.controllers=[],$rootScope.$on("loading:show",function(e,data){var scope=$rootScope.$new();scope.canceller=data?data.canceller.resolve:function(){$rootScope.$broadcast("loading:hide")},$rootScope.loadingQueue.push(scope.canceller),$ionicLoading.show({template:"<ion-spinner></ion-spinner><br>One moment please<br><button class='button white icon-left ion-ios-close-outline button-clear' ng-click='canceller()'>Cancel</button>",scope:scope})}),$rootScope.$on("loading:hide",function(){var scope;$rootScope.loadingQueue.pop(),$ionicLoading.hide(),0<$rootScope.loadingQueue.length&&((scope=$rootScope.$new()).canceller=$rootScope.loadingQueue[$rootScope.loadingQueue.length-1],$ionicLoading.show({template:"<ion-spinner></ion-spinner><br>One moment please<br><button class='button white icon-left ion-ios-close-outline button-clear' ng-click='canceller()'>Cancel</button>",scope:scope}))}),$rootScope.$on("$ionicView.afterEnter",function(){$document[0].title="OpenGarage"}),angular.element($document).on("resume",function(){$timeout(function(){Utils.checkNewController(),Cloud.sync()},100)});var firstLoadHandler=$rootScope.$on("$stateChangeStart",function(event){firstLoadHandler(),event.preventDefault(),Utils.storage.get(["activeController","controllers","cloudToken"],function(data){try{$rootScope.controllers=JSON.parse(data.controllers),$rootScope.activeController=JSON.parse(data.activeController)}catch(err){}$rootScope.controllers||($rootScope.controllers=[]),$rootScope.activeController&&"object"==typeof $rootScope.activeController||($rootScope.activeController={}),Cloud.sync(),Object.keys($rootScope.activeController).length?($state.go("app.home"),Utils.updateController()):$rootScope.controllers.length||data.cloudToken?$state.go("app.controllerSelect"):$state.go("login")}),Utils.checkNewController()});angular.element(window).on("resize",function(){$rootScope.$broadcast("window:resize");var content=document.getElementById("mainContent");content&&768<window.innerWidth&&(content.width=window.innerWidth-275)})}).config(function($stateProvider,$urlRouterProvider,$httpProvider,$compileProvider,$ionicConfigProvider){/MSIE\s|Trident\/|Edge\//.test(window.navigator.userAgent)&&$ionicConfigProvider.platform.default.spinner.icon("android"),$ionicConfigProvider.backButton.previousTitleText(!1).text("Back"),/Firefox/.test(navigator.userAgent)&&$ionicConfigProvider.scrolling.jsScrolling(!1),$compileProvider.aHrefSanitizationWhitelist(/^\s*(https?|ftp|mailto|chrome-extension|app|local|file):/),$compileProvider.imgSrcSanitizationWhitelist(/^\s*(https?|ftp|file|content|blob|ms-appx|x-wmapp0|chrome-extension|app|local):|data:image\//),$stateProvider.state("login",{url:"/login",templateUrl:"templates/login.html",controller:"LoginCtrl"}).state("app",{url:"/app",abstract:!0,templateUrl:"templates/menu.html",controller:"MenuCtrl"}).state("app.home",{url:"/home",views:{menuContent:{templateUrl:"templates/home.html",controller:"HomeCtrl"}},resolve:{checkValid:function($timeout,$q,$state,$rootScope,$filter,Utils){var total=$rootScope.controllers.length,filterFilter=$filter("filter"),invalidOrg=!(!$rootScope.activeController||0!==filterFilter($rootScope.controllers,{mac:$rootScope.activeController.mac}).length);if($rootScope.activeController||1!==total)return!$rootScope.activeController||invalidOrg?(delete $rootScope.activeController,Utils.storage.remove("activeController"),$timeout(function(){$state.go("app.controllerSelect")}),$q.reject()):void 0;Utils.setController(0)}}}).state("app.rules",{url:"/rules",views:{menuContent:{templateUrl:"templates/rules.html",controller:"RulesCtrl"}}}).state("app.controllerSelect",{url:"/controllerSelect",views:{menuContent:{templateUrl:"templates/controllerSelect.html",controller:"ControllerSelectCtrl"}}}).state("app.history",{url:"/history",views:{menuContent:{templateUrl:"templates/history.html",controller:"HistoryCtrl"}},resolve:{checkValid:function($rootScope,$q){if(!$rootScope.activeController)return $q.reject()}}}).state("app.settings",{url:"/settings",views:{menuContent:{templateUrl:"templates/settings.html",controller:"SettingsCtrl"}},resolve:{checkValid:function($rootScope,$q){if(!$rootScope.activeController)return $q.reject()}}}).state("app.help",{url:"/help",views:{menuContent:{templateUrl:"templates/help.html"}}}).state("otherwise",{url:"*path",template:"",controller:function($state,$rootScope){$rootScope.activeController?$state.go("app.home"):$state.go("app.controllerSelect")}}),$httpProvider.interceptors.push(function($rootScope,$q,$injector){return{request:function(config){return config.url.match(/^https?/)&&(config.cancel=$q.defer(),config.timeout=config.cancel.promise,"number"!=typeof config.retryCount&&(config.retryCount=0),config.suppressLoader||$rootScope.$broadcast("loading:show",{canceller:config.cancel})),config},response:function(response){return!response.config.suppressLoader&&response.config.url.match(/^https?/)&&$rootScope.$broadcast("loading:hide"),response},responseError:function(error){if(error.config.timeout&&error.config.timeout.$$state&&1===error.config.timeout.$$state.status&&(error.canceled=!0),!error.config.suppressLoader&&error.config.url.match(/^https?/)&&$rootScope.$broadcast("loading:hide"),error.status<=0&&!error.canceled){if(error.config.retryCount<3){var $http=$injector.get("$http");return error.config.retryCount++,$http(error.config)}return error.retryFailed=!0,error.canceled=!0,$q.reject(error)}return $q.reject(error)}}}),$ionicConfigProvider.views.forwardCache(!0)}).filter("unique",function(){return function(items,filterOn){return!1===filterOn||(filterOn||angular.isUndefined(filterOn))&&angular.isArray(items)&&(newItems=[],extractValueToCompare=function(item){return angular.isObject(item)&&angular.isString(filterOn)?item[filterOn]:item},angular.forEach(items,function(item){for(var isDuplicate=!1,i=0;i<newItems.length;i++)if(angular.equals(extractValueToCompare(newItems[i]),extractValueToCompare(item))){isDuplicate=!0;break}isDuplicate||newItems.push(item)}),items=newItems),items;var newItems,extractValueToCompare}}).directive("geoRuleSetup",function($rootScope,$filter){return{restrict:"E",replace:!0,scope:{rule:"="},templateUrl:"templates/geoRuleSetup.html",link:function(scope,element){var map,marker,circle;scope.updateRule=function(){$rootScope.startGeofence(function(){window.geofence.addOrUpdate({id:scope.rule.direction+"-"+$rootScope.activeController.mac,latitude:scope.rule.start.lat,longitude:scope.rule.start.lng,radius:scope.rule.radius,transitionType:"open"===scope.rule.direction?1:2,notification:{title:"OpenGarage Reminder",text:"Tap here to "+scope.rule.direction+" the garage door...",openAppOnClick:!0}},function(){window.geofence.getWatched(function(fences){$rootScope.geoFences=JSON.parse(fences)})})})},scope.updateMarker=function(){marker&&marker.setMap(null),marker=new google.maps.Marker({position:scope.rule.start,map:map}),scope.updateRule()},scope.updateRadius=function(){circle&&circle.setMap(null),circle=new google.maps.Circle({strokeColor:"#FF0000",strokeOpacity:.8,strokeWeight:2,fillColor:"#FF0000",fillOpacity:.35,map:map,center:scope.rule.start,radius:parseInt(scope.rule.radius)}),scope.updateRule()},scope.updateMap=function(){scope.rule.enable?setTimeout(function(){map=new google.maps.Map(element[0].querySelectorAll(".map")[0],{zoom:16,streetViewControl:!1,mapTypeControl:!1,center:scope.rule.start}),google.maps.event.addListener(map,"click",function(e){scope.rule.start={lat:e.latLng.lat(),lng:e.latLng.lng()},scope.updateMarker(),scope.updateRadius()}),scope.updateMarker(),scope.updateRadius()},100):window.geofence.remove(scope.rule.direction+"-"+$rootScope.activeController.mac,function(){window.geofence.getWatched(function(fences){$rootScope.geoFences=JSON.parse(fences)})})},scope.$watch("rule",function(){var currentRule=$filter("filter")($rootScope.geoFences,{id:scope.rule.direction+"-"+$rootScope.activeController.mac})[0];currentRule?(scope.rule.radius=currentRule.radius,scope.rule.start={lat:currentRule.latitude,lng:currentRule.longitude},scope.rule.enable=!0,scope.updateMap()):(scope.rule.radius=scope.rule.radius||500,scope.rule.start=scope.rule.start||{lat:30.296519,lng:-97.730185},scope.rule.enable=scope.rule.enable||!1,$rootScope.startGeofence(function(){navigator.geolocation.getCurrentPosition(function(position){scope.rule.start={lat:position.coords.latitude,lng:position.coords.longitude},scope.updateMap()},function(){scope.updateMap()},{timeout:1e4})}))})}}}),angular.module("opengarage.cloud",["opengarage.utils"]).factory("Cloud",["$injector","$rootScope","Utils",function($injector,$rootScope,Utils){function requestAuth(){$ionicPopup=$ionicPopup||$injector.get("$ionicPopup");var scope=$rootScope.$new();scope.data={},$ionicPopup.show({templateUrl:"templates/cloudLogin.html",title:"OpenGarage.io Login",scope:scope,buttons:[{text:"Cancel"},{text:"<b>Login</b>",type:"button-positive",onTap:function(e){if(scope.data.username&&scope.data.password)return!0;e.preventDefault()}}]}).then(function(isValid){isValid&&login(scope.data.username,scope.data.password,syncStart)})}function sync(callback){callback=callback||function(){},Utils.storage.get("cloudToken",function(local){"string"==typeof local.cloudToken&&getSites(function(data){!1!==data&&($rootScope.controllers=data,Utils.storage.set({controllers:JSON.stringify(data)},callback),Utils.updateQuickLinks())})})}var $http,$httpParamSerializerJQLike,$filter,$ionicPopup,$ionicActionSheet,login=function(user,pass,callback){callback=callback||function(){},$http=$http||$injector.get("$http"),$httpParamSerializerJQLike=$httpParamSerializerJQLike||$injector.get("$httpParamSerializerJQLike"),$http({method:"POST",url:"https://opengarage.io/wp-admin/admin-ajax.php",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},data:$httpParamSerializerJQLike({action:"ajaxLogin",username:user,password:pass})}).then(function(result){"string"==typeof result.data.token&&(Utils.storage.set({cloudToken:result.data.token,cloudDataToken:sjcl.codec.hex.fromBits(sjcl.hash.sha256.hash(pass))}),$rootScope.isSynced=!0),callback(result.data.loggedin)},function(){callback(!1)})},syncStart=function(){$ionicActionSheet=$ionicActionSheet||$injector.get("$ionicActionSheet"),getSites(function(sites){var finish;JSON.stringify(sites)!==JSON.stringify($rootScope.controllers)&&(0<Object.keys(sites).length?(finish=function(){$rootScope.controllers=sites,Utils.storage.set({controllers:JSON.stringify(sites)},saveSites),Utils.updateQuickLinks()},$ionicActionSheet.show({buttons:[{text:"<i class='icon ion-merge'></i> Merge"},{text:"<i class='icon ion-ios-cloud-download'></i> Replace local with cloud"},{text:"<i class='icon ion-ios-cloud-upload'></i> Replace cloud with local"}],titleText:"Select Merge Method",cancelText:"Cancel",buttonClicked:function(index){return 1===index||(sites=2===index?$rootScope.controllers:($filter=$filter||$injector.get("$filter"))("unique")($rootScope.controllers.concat(sites),"mac")),finish(),!0}})):saveSites())})},getSites=function(callback){callback=callback||function(){},$http=$http||$injector.get("$http"),$httpParamSerializerJQLike=$httpParamSerializerJQLike||$injector.get("$httpParamSerializerJQLike"),Utils.storage.get(["cloudToken","cloudDataToken"],function(local){return void 0!==local.cloudToken&&null!==local.cloudToken?void 0===local.cloudDataToken||null===local.cloudDataToken?(handleInvalidDataToken(),void callback(!1)):void $http({method:"POST",url:"https://opengarage.io/wp-admin/admin-ajax.php",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},data:$httpParamSerializerJQLike({action:"getSites",token:local.cloudToken,controllerType:"opengarage"})}).then(function(result){if(!1===result.data.success||""===result.data.sites)"BAD_TOKEN"===result.data.message&&handleExpiredLogin(),callback(!1,result.data.message);else{var sites;Utils.storage.set({cloudToken:result.data.token});try{sites=sjcl.decrypt(local.cloudDataToken,result.data.sites)}catch(err){"ccm: tag doesn't match"===err.message&&handleInvalidDataToken(),callback(!1)}try{callback(JSON.parse(sites))}catch(err){callback(!1)}}},function(){callback(!1)}):void callback(!1)})},saveSites=function(callback){"function"!=typeof callback&&(callback=function(){}),$http=$http||$injector.get("$http"),$httpParamSerializerJQLike=$httpParamSerializerJQLike||$injector.get("$httpParamSerializerJQLike"),Utils.storage.get(["cloudToken","cloudDataToken"],function(data){null!==data.cloudToken&&void 0!==data.cloudToken?$http({method:"POST",url:"https://opengarage.io/wp-admin/admin-ajax.php",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},suppressLoader:!0,data:$httpParamSerializerJQLike({action:"saveSites",token:data.cloudToken,controllerType:"opengarage",sites:encodeURIComponent(JSON.stringify(sjcl.encrypt(data.cloudDataToken,JSON.stringify($rootScope.controllers))))})}).then(function(result){!1===result.data.success?("BAD_TOKEN"===result.data.message&&handleExpiredLogin(),callback(!1,result.data.message)):(Utils.storage.set({cloudToken:result.data.token}),callback(result.data.success))},function(){callback(!1)}):callback(!1)})},handleInvalidDataToken=function(){Utils.storage.remove("cloudDataToken"),($ionicPopup=$ionicPopup||$injector.get("$ionicPopup")).prompt({title:"Unable to read cloud data",subTitle:"Enter a valid password to decrypt the data",template:"Please enter your OpenSprinkler.com password. If you have recently changed your password, you may need to enter your previous password to decrypt the data.",inputType:"password",inputPlaceholder:"Password"}).then(function(password){Utils.storage.set({cloudDataToken:sjcl.codec.hex.fromBits(sjcl.hash.sha256.hash(password))}),sync()})},handleExpiredLogin=function(){Utils.storage.remove("cloudToken"),($ionicPopup=$ionicPopup||$injector.get("$ionicPopup")).confirm({title:"OpenGarage.io Login Expired",template:"Click here to re-login to OpenGarage.io"}).then(function(result){result&&requestAuth()})};return Utils.storage.get(["cloudToken","cloudDataToken"],function(data){null===data.cloudToken||void 0===data.cloudToken||void 0===data.cloudDataToken||void 0===data.cloudDataToken?$rootScope.isSynced=!1:$rootScope.isSynced=!0}),$rootScope.$on("controllersUpdated",saveSites),{requestAuth:requestAuth,login:login,logout:function(){Utils.storage.remove("cloudToken"),$rootScope.isSynced=!1},syncStart:syncStart,sync:sync,getSites:getSites,saveSites:saveSites,handleInvalidDataToken:handleInvalidDataToken,handleExpiredLogin:handleExpiredLogin,getTokenUser:function(token){return atob(token).split("|")[0]}}}]),angular.module("opengarage.controllers",["opengarage.utils","opengarage.cloud"]).controller("LoginCtrl",function($scope,$rootScope,$state,$ionicPopup,Cloud){$scope.data={},$scope.submit=function(){$scope.data.username?$scope.data.password?Cloud.login($scope.data.username,$scope.data.password,function(){Cloud.sync(function(){$state.go("app.controllerSelect")})}):$ionicPopup.alert({template:"<p class='center'>Please enter a password to continue.</p>"}):$ionicPopup.alert({template:"<p class='center'>Please enter a username to continue.</p>"})},$scope.skipCloud=function(){$state.go("app.controllerSelect")}}).controller("ControllerSelectCtrl",function($scope,$state,$rootScope,$timeout,$filter,$ionicModal,$ionicHistory,Utils,Cloud){$scope.data={showDelete:!1},$scope.selectPhoto=Utils.selectPhoto,$scope.setController=function(index){Utils.setController(index),$ionicHistory.nextViewOptions({historyRoot:!0}),$state.go("app.home")},$scope.deleteController=function(index){Utils.getControllerIndex()===index&&(delete $rootScope.activeController,Utils.storage.remove("activeController")),$rootScope.controllers.splice(index,1),Utils.storage.set({controllers:JSON.stringify($rootScope.controllers)}),$rootScope.$broadcast("controllersUpdated")},$scope.moveItem=function(item,fromIndex,toIndex){$rootScope.controllers.splice(fromIndex,1),$rootScope.controllers.splice(toIndex,0,item),Utils.storage.set({controllers:JSON.stringify($rootScope.controllers)}),$rootScope.$broadcast("controllersUpdated")},$scope.getTime=function(timestamp){return new Date(timestamp).toLocaleString()},$scope.changeSync=function(){$rootScope.isSynced?Cloud.logout():Cloud.requestAuth()}}).controller("HistoryCtrl",function($scope,$filter,Utils){$scope.$on("$ionicView.beforeEnter",function(){Utils.getLogs(function(reply){if(reply){var i,current,day;for($scope.isLocal=!0,i=0;i<reply.length;i++)(current=new Date(1e3*reply[i][0]).toDateString())!==day&&(day=current,reply.splice(i,0,{isDivider:"true",day:current}));$scope.logs=reply}else $scope.isLocal=!1})})}).controller("SettingsCtrl",function($scope,$state,$ionicPopup,Utils){$scope.settings={},$scope.changePassword=Utils.changePassword,$scope.restart=Utils.restartController,$scope.submit=function(){Utils.saveOptions($scope.settings,function(reply){var text;reply?(text="Settings saved successfully!",$state.go("app.home")):text="Unable to save settings. Please check the connection to the device and try again.",$ionicPopup.alert({template:"<p class='center'>"+text+"</p>"})})},$scope.$on("$ionicView.beforeEnter",function(){Utils.getControllerOptions(function(reply){reply?($scope.isLocal=!0,delete reply.mod,delete reply.fwv,$scope.settings=reply):$scope.isLocal=!1},null,!0)})}).controller("MenuCtrl",function($scope,$rootScope,$ionicActionSheet,$ionicPopup,$ionicSideMenuDelegate,$timeout,Utils){$scope.sideMenuDraggable=0===Utils.getControllerIndex(),$rootScope.$on("controllerUpdated",function(){$scope.sideMenuDraggable=0===Utils.getControllerIndex()}),$scope.showAddController=function(){$ionicActionSheet.show({buttons:[{text:"<i class='icon ion-plus-circled'></i> Add by IP"},{text:"<i class='icon ion-network'></i> Add by Blynk Token"},{text:"<i class='icon ion-network'></i> Add by OpenThings Cloud Token"},{text:"<i class='icon ion-ios-color-wand'></i> Setup New Device"}],titleText:"Add Controller",cancelText:"Cancel",buttonClicked:function(index){return 0===index?Utils.showAddController():1===index?Utils.showAddBlynk():2===index?Utils.showAddOtc():Utils.checkNewController(function(result){result||$ionicPopup.alert({template:"<p class='center'>Please first connect the power to your OpenGarage. Once complete, connect this device to the wifi network broadcast by the OpenGarage (named OG_XXXXXX) and reopen this app.</p>"})},!1),!0}})},$scope.closeMenu=function(){$ionicSideMenuDelegate.toggleLeft(!1)}}).controller("HomeCtrl",function($rootScope,$scope,$filter,$http,$timeout,Utils){var interval;$scope.toggleDoor=Utils.toggleDoor,$scope.selectPhoto=Utils.selectPhoto,$scope.currentIndex=Utils.getControllerIndex(),$scope.changeController=function(direction){var current=Utils.getControllerIndex(),to=current+direction;-1===current||to<0||to>=$rootScope.controllers.length||($scope.currentIndex=to,Utils.setController(to))},$scope.$on("$ionicView.beforeLeave",function(){clearInterval(interval)}),$scope.$on("$ionicView.beforeEnter",function(){interval=setInterval(Utils.updateController,5e3)}),$rootScope.$on("controllerUpdated",function(){$scope.currentIndex=Utils.getControllerIndex(),$timeout(function(){$scope.$apply()})})}).controller("RulesCtrl",function($scope,$rootScope){function reset(){$scope.geo={home:{direction:"open"},away:{direction:"close"}},$scope.set("home")}$scope.isAndroid=ionic.Platform.isAndroid(),$scope.set=function(type){$scope.current="home"===type?$scope.geo.home:$scope.geo.away},$rootScope.$on("controllerUpdated",reset),reset()});var OPENTHINGS_CLOUD_HOST="https://cloud.openthings.io";angular.module("opengarage.utils",[]).factory("Utils",["$injector","$rootScope",function($injector,$rootScope){function getControllerSettings(callback,ip,token){if(ip||token||$rootScope.activeController)return $q=$q||$injector.get("$q"),$http=$http||$injector.get("$http"),(token&&!isOTCToken(token)||!ip&&$rootScope.activeController&&$rootScope.activeController.auth&&!isOTCToken($rootScope.activeController.auth)?$q.all({name:$http({method:"POST",url:"https://opengarage.io/wp-admin/admin-ajax.php",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},data:"action=blynkCloud&path="+encodeURIComponent(token||$rootScope.activeController.auth)+"/project",suppressLoader:!0}),door:$http({method:"POST",url:"https://opengarage.io/wp-admin/admin-ajax.php",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},data:"action=blynkCloud&path="+encodeURIComponent(token||$rootScope.activeController.auth)+"/get/V0",suppressLoader:!0}),vehicle:$http({method:"POST",url:"https://opengarage.io/wp-admin/admin-ajax.php",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},data:"action=blynkCloud&path="+encodeURIComponent(token||$rootScope.activeController.auth)+"/get/V4",suppressLoader:!0})}):$http({method:"GET",url:getBaseUrl(ip,token)+"/jc",suppressLoader:!ip})).then(function(result){if(200===result.status)if(token&&!isOTCToken(token)||!ip&&$rootScope.activeController&&$rootScope.activeController.auth&&!isOTCToken($rootScope.activeController.auth)){if("Invalid token."===result.name.data)return void callback(!1);callback({name:result.name.data.name,door:255===parseInt(result.door.data[0])?1:0,lastUpdate:result.name.data.updatedAt,vehicle:255===parseInt(result.vehicle.data[0])?1:0})}else result.data.lastUpdate=(new Date).getTime(),callback(result.data);else callback(!1)},function(){callback(!1)});callback(!1)}function getControllerOptions(callback,ip,showLoader){if((ip||$rootScope.activeController)&&(!$rootScope.activeController||$rootScope.activeController.ip||isOTCToken($rootScope.activeController.auth)))return($http=$http||$injector.get("$http"))({method:"GET",url:getBaseUrl(ip)+"/jo",suppressLoader:!showLoader}).then(function(result){callback(result.data)},function(){callback(!1)});callback(!1)}function updateController(){var controller=angular.copy($rootScope.activeController)||{};return getControllerSettings(function(data){!1!==data?($rootScope.connected=!0,angular.extend(controller,data)):$rootScope.connected=!1}).then(function(){var index=getControllerIndex();0<=index&&controller.mac===$rootScope.activeController.mac&&($rootScope.controllers[index]=controller,$rootScope.activeController=controller,$rootScope.$broadcast("controllerUpdated"),$rootScope.$broadcast("controllersUpdated"),storage.set({controllers:JSON.stringify($rootScope.controllers),activeController:JSON.stringify($rootScope.activeController)}))})}function addController(data,callback){return callback=callback||function(){},$ionicPopup=$ionicPopup||$injector.get("$ionicPopup"),data.token||data.ip&&data.password?data.token&&32!==data.token.length?($ionicPopup.alert({template:"<p class='center'>A valid "+(data.token.startsWith("OT")?"OpenThings Cloud":"Blynk")+" token is required. Please verify your token and try again.</p>"}),void callback(!1)):void getControllerSettings(function(result){if(result||($ionicPopup.alert({template:"<p class='center'>Unable to find device. Please verify the IP/password and try again.</p>"}),callback(!1)),$filter=$filter||$injector.get("$filter"),result.mac){if(result.ip=data.ip,result.auth=data.token,result.password=data.password,0<$filter("filter")($rootScope.controllers,{mac:result.mac}).length)return $ionicPopup.alert({template:"<p class='center'>Device already added to site list.</p>"}),void callback(!1);getControllerOptions(function(reply){angular.extend(result,reply),$rootScope.controllers.push(result),storage.set({controllers:JSON.stringify($rootScope.controllers)}),$rootScope.$broadcast("controllersUpdated"),callback(!0)},data.ip)}data.token&&!isOTCToken(data.token)&&$http({method:"POST",url:"https://opengarage.io/wp-admin/admin-ajax.php",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},data:"action=blynkCloud&path="+data.token+"/get/V2",suppressLoader:!0}).then(function(reply){return"Invalid token."===reply.data?($ionicPopup.alert({template:"<p class='center'>Invalid Blynk token.</p>"}),void callback(!1)):(reply=reply.data.pop().split(" ")[1].split("_")[1],result.mac="5C:CF:7F:"+reply.match(/.{1,2}/g).join(":"),result.auth=data.token,0<$filter("filter")($rootScope.controllers,{mac:result.mac}).length?($ionicPopup.alert({template:"<p class='center'>Device already added to site list.</p>"}),void callback(!1)):($rootScope.controllers.push(result),storage.set({controllers:JSON.stringify($rootScope.controllers)}),$rootScope.$broadcast("controllersUpdated"),void callback(!0)))})},data.token?null:data.ip,data.token?data.token:null):($ionicPopup.alert({template:"<p class='center'>Both an IP and password are required.</p>"}),void callback(!1))}function checkNewController(callback,suppressLoader){$http=$http||$injector.get("$http"),callback=callback||function(){},$ionicModal=$ionicModal||$injector.get("$ionicModal"),$http({method:"GET",url:"http://192.168.4.1/js",suppressLoader:void 0===suppressLoader||suppressLoader,timeout:5e3,retryCount:3}).then(function(result){var scope;result.data.ssids?((scope=$rootScope.$new()).data={},scope.save=function(){scope.modal.hide(),connectNewController(scope.data)},scope.ssids=result.data.ssids,$ionicModal.fromTemplateUrl("templates/newControllerSetup.html",{scope:scope,animation:"slide-in-up"}).then(function(modal){(scope.modal=modal).show()}),callback(!0)):callback(!1)},function(){callback(!1)})}var $http,$q,$filter,$ionicPopup,$ionicModal,isFireFox=/Firefox/.test(window.navigator.userAgent),isIE=/MSIE\s|Trident\/|Edge\//.test(window.navigator.userAgent),storage={get:function(query,callback){callback=callback||function(){};var i,data={};for(i in"string"==typeof query&&(query=[query]),query)query.hasOwnProperty(i)&&(data[query[i]]=localStorage.getItem(query[i]));callback(data)},set:function(query,callback){var i;if(callback=callback||function(){},"object"==typeof query)for(i in query)query.hasOwnProperty(i)&&localStorage.setItem(i,query[i]);callback(!0)},remove:function(query,callback){var i;for(i in callback=callback||function(){},"string"==typeof query&&(query=[query]),query)query.hasOwnProperty(i)&&localStorage.removeItem(query[i]);callback(!0)}},getControllerIndex=function(mac){if(!$rootScope.activeController&&!mac)return null;mac=mac||(null===$rootScope.activeController?"":$rootScope.activeController.mac);for(var i=0;i<$rootScope.controllers.length;i++)if($rootScope.controllers[i].mac===mac)return i;return null},connectNewController=function(data){$http=$http||$injector.get("$http"),$ionicPopup=$ionicPopup||$injector.get("$ionicPopup"),$http({method:"GET",url:"http://192.168.4.1/cc?ssid="+encodeURIComponent(data.ssid)+"&pass="+encodeURIComponent(data.password)}).then(function(result){1===result.data.result?setTimeout(saveNewController,2e3):$ionicPopup.alert({template:"<p class='center'>Invalid SSID/password combination. Please try again.</p>"}).then(checkNewController)},function(){$ionicPopup.alert({template:"<p class='center'>Unable to reach controller. Please try again.</p>"}).then(checkNewController)})},saveNewController=function(){$http=$http||$injector.get("$http"),$ionicPopup=$ionicPopup||$injector.get("$ionicPopup"),$http({method:"GET",url:"http://192.168.4.1/jt"}).then(function(result){var int;0!==result.data.ip?($ionicPopup.alert({template:"<p class='center'>Controller succesfully connected! Please wait while the device reboots.</p>"}),$rootScope.controllers.push({ip:(int=result.data.ip)%256+"."+(int/256>>0)%256+"."+((int/256>>0)/256>>0)%256+"."+(((int/256>>0)/256>>0)/256>>0),password:"opendoor",name:"My OpenGarage"}),storage.set({controllers:JSON.stringify($rootScope.controllers)}),$rootScope.$broadcast("controllersUpdated")):$ionicPopup.alert({template:"<p class='center'>Controller was unable to connect. Please check your SSID and password and try again.</p>"})})},updateQuickLinks=function(){window.ThreeDeeTouch&&window.ThreeDeeTouch.isAvailable(function(isAvailable){if(isAvailable&&$rootScope.controllers.length){for(var links=[],limit=$rootScope.controllers.length<4?$rootScope.controllers.length:4,i=0;i<limit;i++)links.push({type:"toggle-"+$rootScope.controllers[i].mac,title:"Toggle "+$rootScope.controllers[i].name,iconType:"Update"});window.ThreeDeeTouch.configureQuickActions(links)}})},cancelPendingHttp=function(){($http=$http||$injector.get("$http")).pendingRequests.forEach(function(pendingReq){pendingReq.cancel&&pendingReq.cancel.resolve()})},getBaseUrl=function(ip,token){return token&&isOTCToken(token)||!ip&&$rootScope.activeController&&isOTCToken($rootScope.activeController.auth)?OPENTHINGS_CLOUD_HOST+"/forward/v1/"+(token||$rootScope.activeController.auth):"http://"+(ip||$rootScope.activeController.ip)},isOTCToken=function(token){return token&&token.startsWith("OTC-")};return isFireFox&&(HTMLElement.prototype.click=function(){var evt=this.ownerDocument.createEvent("MouseEvents");evt.initMouseEvent("click",!0,!0,this.ownerDocument.defaultView,1,0,0,0,0,!1,!1,!1,!1,0,null),this.dispatchEvent(evt)}),$rootScope.$on("controllersUpdated",updateQuickLinks),{isIE:isIE,storage:storage,getControllerSettings:getControllerSettings,getControllerOptions:getControllerOptions,updateController:updateController,setController:function(controller,callback){callback=callback||function(){},cancelPendingHttp(),$rootScope.activeController="object"==typeof controller?controller:$rootScope.controllers[controller],$rootScope.connected=!1,updateController(),storage.set({activeController:JSON.stringify($rootScope.activeController)},callback),updateQuickLinks()},getControllerIndex:getControllerIndex,checkNewController:checkNewController,updateQuickLinks:updateQuickLinks,showAddController:function(callback){callback=callback||function(){},$ionicPopup=$ionicPopup||$injector.get("$ionicPopup");var scope=$rootScope.$new();scope.data={canScan:!!window.networkinterface},scope.scan=function(){var callback;callback=function(result){result&&result.length?scope.data.foundControllers=result:$ionicPopup.alert({template:"<p class='center'>No devices detected on your network</p>"})},window.networkinterface?window.networkinterface.getIPAddress(function(router){if(router){$q=$q||$injector.get("$q"),$http=$http||$injector.get("$http"),(router=router.split(".")).pop();var i,baseip=router.join("."),queue=[],matches=[];for($rootScope.$broadcast("loading:show"),i=1;i<=244;i++)queue.push(function(ip){return $http({method:"GET",url:"http://"+baseip+"."+ip+"/jc",suppressLoader:!0,timeout:6e3,retryCount:3}).then(function(result){result.data&&result.data.mac&&matches.push(baseip+"."+ip)}).catch(function(){return!1})}(i));$q.all(queue).then(function(){$rootScope.$broadcast("loading:hide"),callback(matches)})}else callback(!1)}):callback(!1)},scope.save=function(ip){var callback;popup.close(),callback=function(password){addController({ip:ip,password:password})},($ionicPopup=$ionicPopup||$injector.get("$ionicPopup")).prompt({title:"Enter Controller Password",template:"Enter your controller's password below:",inputType:"password",inputPlaceholder:"Controller Password"}).then(function(password){callback(password)})};var popup=$ionicPopup.show({templateUrl:"templates/addController.html",title:"Add Controller",scope:scope,buttons:[{text:"Cancel"},{text:"<b>Add</b>",type:"button-positive",onTap:function(e){if(scope.data.ip&&scope.data.password)return!0;e.preventDefault()}}]});popup.then(function(isValid){isValid&&addController(scope.data,callback)})},showAddBlynk:function(callback){callback=callback||function(){},($ionicPopup=$ionicPopup||$injector.get("$ionicPopup")).prompt({title:"Add Controller by Blynk",template:"Enter your Blynk Auth token below:",inputType:"text",inputPlaceholder:"Your Blynk Auth token"}).then(function(token){token&&addController({token:token},callback)})},showAddOtc:function(callback){callback=callback||function(){},($ionicPopup=$ionicPopup||$injector.get("$ionicPopup")).prompt({title:"Add Controller by OpenThings Cloud",template:"Enter your OpenThings Cloud auth token below:",inputType:"text",inputPlaceholder:"Your OpenThings Auth token"}).then(function(token){token&&addController({token:token},callback)})},toggleDoor:function(auth,callback){"function"==typeof auth&&(callback=auth,auth=null),callback=callback||function(){},$http=$http||$injector.get("$http"),(auth&&!isOTCToken(auth)||$rootScope.activeController&&$rootScope.activeController.auth&&!isOTCToken($rootScope.activeController.auth)?$http({method:"POST",url:"https://opengarage.io/wp-admin/admin-ajax.php",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},data:"action=blynkCloud&path="+encodeURIComponent((auth||$rootScope.activeController.auth)+"/update/V1?value=1")}).then(function(){setTimeout(function(){$http({method:"POST",url:"https://opengarage.io/wp-admin/admin-ajax.php",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},suppressLoader:!0,data:"action=blynkCloud&path="+encodeURIComponent((auth||$rootScope.activeController.auth)+"/update/V1?value=0")})},$rootScope.activeController.cdt||1e3)}):$http.get(getBaseUrl()+"/cc?dkey="+encodeURIComponent($rootScope.activeController.password)+"&click=1")).then(function(){callback(!0)},function(){callback(!1)})},restartController:function(){$http=$http||$injector.get("$http"),$ionicPopup=$ionicPopup||$injector.get("$ionicPopup"),$rootScope.activeController&&$ionicPopup.confirm({title:"Restart Controller?",template:"<p class='center'>Are you sure you want to restart the controller?</p>"}).then(function(result){result&&$http.get(getBaseUrl()+"/cc?dkey="+encodeURIComponent($rootScope.activeController.password)+"&reboot=1")})},saveOptions:function(settings,callback){return($http=$http||$injector.get("$http"))({method:"GET",url:getBaseUrl()+"/co?dkey="+$rootScope.activeController.password,params:settings,paramSerializer:"$httpParamSerializerJQLike"}).then(function(result){callback(result.data)},function(){callback(!1)})},changePassword:function(){$ionicPopup=$ionicPopup||$injector.get("$ionicPopup");var scope=$rootScope.$new();scope.pwd={},$ionicPopup.show({templateUrl:"templates/changePassword.html",title:"Change Password",scope:scope,buttons:[{text:"Cancel"},{text:"<b>Go</b>",type:"button-positive"}]}).then(function(){scope.pwd.nkey&&scope.pwd.ckey&&scope.pwd.nkey===scope.pwd.ckey&&($http=$http||$injector.get("$http"),$filter=$filter||$injector.get("$filter"),$http({method:"GET",url:getBaseUrl()+"/co?dkey="+$rootScope.activeController.password,params:scope.pwd,paramSerializer:"$httpParamSerializerJQLike"}).then(function(){$rootScope.activeController.password=scope.pwd.nkey;var index=$rootScope.controllers.indexOf(($filter("filter")($rootScope.controllers,{mac:$rootScope.activeController.mac})||[])[0]);index&&($rootScope.controllers[index]=$rootScope.activeController,storage.set({controllers:JSON.stringify($rootScope.controllers),activeController:JSON.stringify($rootScope.activeController)}),$rootScope.$broadcast("controllersUpdated")),$ionicPopup.alert({template:"<p class='center'>Password updated succesfully!</p>"})}))})},getLogs:function(callback){$rootScope.activeController&&isOTCToken($rootScope.activeController.auth)?($http=$http||$injector.get("$http"))({method:"GET",url:getBaseUrl()+"/jl"}).then(function(result){callback(result.data.logs.sort(function(a,b){return b[0]-a[0]}))},function(){callback(!1)}):callback(!1)},selectPhoto:function($event,index,deletePhoto){$ionicModal=$ionicModal||$injector.get("$ionicModal");var scope=$rootScope.$new(),fileInput=angular.element(document.getElementById("photoUpload"));if(scope.data={image:!1,cropped:!1,index:!1},scope.uploadPhoto=function(index){scope.crop.hide(),getControllerIndex()===index&&($rootScope.activeController.image=scope.data.cropped,storage.set({activeController:JSON.stringify($rootScope.activeController)})),$rootScope.controllers[index].image=scope.data.cropped,storage.set({controllers:JSON.stringify($rootScope.controllers)}),$rootScope.$broadcast("controllersUpdated")},$ionicModal.fromTemplateUrl("templates/crop.html",{scope:scope}).then(function(modal){scope.crop=modal}),$event.stopPropagation(),deletePhoto)return getControllerIndex()===index&&(delete $rootScope.activeController.image,storage.set({activeController:JSON.stringify($rootScope.activeController)})),delete $rootScope.controllers[index].image,storage.set({controllers:JSON.stringify($rootScope.controllers)}),void $rootScope.$broadcast("controllersUpdated");fileInput.parent()[0].reset(),fileInput.one("change",function(){var reader,file=fileInput[0].files[0];file.type&&file.type.match("image.*")&&((reader=new FileReader).onload=function(evt){scope.data.image=evt.target.result,scope.data.index=index,scope.crop.show()},reader.readAsDataURL(file))}),fileInput[0].click()}}}]),angular.module("opengarage.watch",[]).factory("Watch",["$injector","$rootScope",function($injector,$rootScope){function loadApp(){window.applewatch.loadAppMain({title:"OpenGarage",label:{value:"Toggle Garage Door",color:"#FFA500",font:{size:12}},table:{callback:"toggleDoorByIndex",alpha:1,rows:makeAppList()}})}var makeAppList=function(){var rows=[];return $rootScope.controllers.forEach(function(controller){var canvas,ctx,img,item={type:"OneColumnSelectableRowType",group:{backgroundColor:"#1884C4",cornerRadius:8},label:{value:" "+controller.name}};controller.image&&(ctx=(canvas=document.createElement("canvas")).getContext("2d"),(img=new Image).src=controller.image,canvas.width=25,canvas.height=30,ctx.drawImage(img,0,0,canvas.width,canvas.height),item.imageLeft={data:canvas.toDataURL("image/png"),width:canvas.width,height:canvas.height}),rows.push(item)}),rows};return $rootScope.$on("controllersUpdated",function(){window.applewatch&&loadApp()}),{loadApp:loadApp}}]);
//# sourceMappingURL=app.min.js.map
