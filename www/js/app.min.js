angular.module("opengarage",["ionic","uiCropper","opengarage.controllers","opengarage.utils"]).run(function($state,$ionicPlatform,$ionicScrollDelegate,$ionicHistory,$location,$document,$window,$rootScope,$ionicLoading,$ionicPopup,$timeout,Utils){$ionicPlatform.ready(function(){$rootScope.open=function(url){window.open(url,"_blank","toolbarposition=top")},window.cordova&&window.cordova.plugins&&window.cordova.plugins.Keyboard&&window.cordova.plugins.Keyboard.hideKeyboardAccessoryBar&&window.cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),window.StatusBar&&(window.StatusBar.styleLightContent(),window.StatusBar.backgroundColorByHexString("#444"),angular.element($window).on("statusTap",function(){$ionicScrollDelegate.scrollTop()})),$timeout(function(){try{navigator.splashscreen.hide()}catch(err){}},500)}),$rootScope.connected=!1,$rootScope.version=window.appVersion,$rootScope.loadingCount=0,$rootScope.controllers=[],$rootScope.$on("loading:show",function(e,data){$rootScope.loadingCount++,$rootScope.canceller=data?data.canceller.resolve:angular.noop,$ionicLoading.show({template:"<ion-spinner></ion-spinner><br>One moment please<br><button class='button white icon-left ion-ios-close-outline button-clear' ng-click='$root.canceller()'>Cancel</button>"})}),$rootScope.$on("loading:hide",function(){$rootScope.loadingCount--,$rootScope.loadingCount<=0&&($rootScope.loadingCount=0,$ionicLoading.hide())}),$rootScope.$on("$ionicView.afterEnter",function(){$document[0].title="OpenGarage"}),angular.element($document).on("resume",function(){$timeout(Utils.checkNewController,100)});var firstLoadHandler=$rootScope.$on("$stateChangeStart",function(event){firstLoadHandler(),event.preventDefault(),Utils.storage.get(["activeController","controllers"],function(data){try{$rootScope.controllers=JSON.parse(data.controllers),$rootScope.activeController=JSON.parse(data.activeController)}catch(err){}$rootScope.controllers||($rootScope.controllers=[]),$rootScope.activeController&&"object"==typeof $rootScope.activeController?($state.go("app.home"),Utils.updateController()):$state.go("app.controllerSelect")}),Utils.checkNewController()});angular.element(window).on("resize",function(){$rootScope.$broadcast("window:resize"),window.innerWidth>768&&(document.getElementById("mainContent").width=window.innerWidth-275)})}).config(function($stateProvider,$urlRouterProvider,$httpProvider,$compileProvider,$ionicConfigProvider){/MSIE\s|Trident\/|Edge\//.test(window.navigator.userAgent)&&$ionicConfigProvider.platform["default"].spinner.icon("android"),$ionicConfigProvider.backButton.previousTitleText(!1).text("Back"),/Firefox/.test(navigator.userAgent)&&$ionicConfigProvider.scrolling.jsScrolling(!1),$compileProvider.aHrefSanitizationWhitelist(/^\s*(https?|ftp|mailto|chrome-extension|app|local|file):/),$compileProvider.imgSrcSanitizationWhitelist(/^\s*(https?|ftp|file|content|blob|ms-appx|x-wmapp0|chrome-extension|app|local):|data:image\//),$stateProvider.state("app",{url:"/app","abstract":!0,templateUrl:"templates/menu.html",controller:"MenuCtrl"}).state("app.home",{url:"/home",views:{menuContent:{templateUrl:"templates/home.html",controller:"HomeCtrl"}},resolve:{checkValid:function($timeout,$q,$state,$rootScope,$filter,Utils){var total=$rootScope.controllers.length,filterFilter=$filter("filter"),invalidOrg=!(!$rootScope.activeController||0!==filterFilter($rootScope.controllers,{mac:$rootScope.activeController.mac}).length);return $rootScope.activeController||1!==total?!$rootScope.activeController||invalidOrg?(delete $rootScope.activeController,Utils.storage.remove("activeController"),$timeout(function(){$state.go("app.controllerSelect")}),$q.reject()):void 0:($rootScope.activeController=$rootScope.controllers[0],Utils.updateController(),void Utils.storage.set({activeController:JSON.stringify($rootScope.activeController)}))}}}).state("app.controllerSelect",{url:"/controllerSelect",views:{menuContent:{templateUrl:"templates/controllerSelect.html",controller:"ControllerSelectCtrl"}}}).state("app.history",{url:"/history",views:{menuContent:{templateUrl:"templates/history.html",controller:"HistoryCtrl"}},resolve:{checkValid:function($rootScope,$q){if(!$rootScope.activeController)return $q.reject()}}}).state("app.settings",{url:"/settings",views:{menuContent:{templateUrl:"templates/settings.html",controller:"SettingsCtrl"}},resolve:{checkValid:function($rootScope,$q){if(!$rootScope.activeController)return $q.reject()}}}).state("app.help",{url:"/help",views:{menuContent:{templateUrl:"templates/help.html"}}}).state("otherwise",{url:"*path",template:"",controller:function($state,$rootScope){$rootScope.activeController?$state.go("app.home"):$state.go("app.controllerSelect")}}),$httpProvider.interceptors.push(function($rootScope,$q,$injector){return{request:function(config){if(!config.suppressLoader){var canceller=$q.defer();config.timeout=canceller.promise,"number"!=typeof config.retryCount&&(config.retryCount=0),$rootScope.$broadcast("loading:show",{canceller:canceller})}return config},response:function(response){return response.config.suppressLoader||$rootScope.$broadcast("loading:hide"),response},responseError:function(error){if(error.config.timeout&&error.config.timeout.$$state&&1===error.config.timeout.$$state.status&&(error.canceled=!0),error.config.suppressLoader||$rootScope.$broadcast("loading:hide"),error.status<=0&&!error.canceled){if(error.config.retryCount<3){var $http=$injector.get("$http");return error.config.retryCount++,$http(error.config)}return error.retryFailed=!0,error.canceled=!0,$q.reject(error)}return $q.reject(error)}}}),$ionicConfigProvider.views.forwardCache(!0)}).filter("unique",function(){return function(items,filterOn){if(filterOn===!1)return items;if((filterOn||angular.isUndefined(filterOn))&&angular.isArray(items)){var newItems=[],extractValueToCompare=function(item){return angular.isObject(item)&&angular.isString(filterOn)?item[filterOn]:item};angular.forEach(items,function(item){for(var isDuplicate=!1,i=0;i<newItems.length;i++)if(angular.equals(extractValueToCompare(newItems[i]),extractValueToCompare(item))){isDuplicate=!0;break}isDuplicate||newItems.push(item)}),items=newItems}return items}}),angular.module("opengarage.cloud",["opengarage.utils"]).factory("Cloud",["$injector","$rootScope","Utils",function($injector,$rootScope,Utils){var $http,$httpParamSerializerJQLike,$filter,$ionicPopup,$ionicActionSheet,requestAuth=function(){$ionicPopup=$ionicPopup||$injector.get("$ionicPopup");var scope=$rootScope.$new();scope.data={},$ionicPopup.show({templateUrl:"templates/cloudLogin.html",title:"OpenGarage.io Login",scope:scope,buttons:[{text:"Cancel"},{text:"<b>Login</b>",type:"button-positive",onTap:function(e){return!(!scope.data.username||!scope.data.password)||void e.preventDefault()}}]}).then(function(isValid){isValid&&login(scope.data.username,scope.data.password,syncStart)})},login=function(user,pass,callback){callback=callback||function(){},$http=$http||$injector.get("$http"),$httpParamSerializerJQLike=$httpParamSerializerJQLike||$injector.get("$httpParamSerializerJQLike"),$http({method:"POST",url:"https://opengarage.io/wp-admin/admin-ajax.php",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},data:$httpParamSerializerJQLike({action:"ajaxLogin",username:user,password:pass})}).then(function(result){"string"==typeof result.data.token&&Utils.storage.set({cloudToken:result.data.token,cloudDataToken:sjcl.codec.hex.fromBits(sjcl.hash.sha256.hash(pass))}),callback(result.data.loggedin)},function(){callback(!1)})},logout=function(){Utils.storage.remove("cloudToken"),$rootScope.isSynced=!1},syncStart=function(){$ionicActionSheet=$ionicActionSheet||$injector.get("$ionicActionSheet"),getSites(function(sites){if(JSON.stringify(sites)!==JSON.stringify($rootScope.controllers))if(Object.keys(sites).length>0){var finish=function(){$rootScope.controllers=sites,Utils.storage.set({controllers:JSON.stringify(sites)},saveSites)};$ionicActionSheet.show({buttons:[{text:"Merge"},{text:"Replace local with cloud"},{text:"Replace cloud with local"}],titleText:"Select Merge Method",cancelText:"Cancel",buttonClicked:function(index){return 1===index?finish():2===index?(sites=$rootScope.controllers,finish()):($filter=$filter||$injector.get("$filter"),sites=$filter("unique")($rootScope.controllers.concat(sites),"mac"),finish()),!0}})}else saveSites()})},sync=function(callback){callback=callback||function(){},Utils.storage.get("cloudToken",function(local){"string"==typeof local.cloudToken&&getSites(function(data){data!==!1&&Utils.storage.set({controllers:JSON.stringify(data)},callback)})})},getSites=function(callback){callback=callback||function(){},$http=$http||$injector.get("$http"),$httpParamSerializerJQLike=$httpParamSerializerJQLike||$injector.get("$httpParamSerializerJQLike"),Utils.storage.get(["cloudToken","cloudDataToken"],function(local){return void 0===local.cloudToken||null===local.cloudToken?void callback(!1):void 0===local.cloudDataToken||null===local.cloudDataToken?(handleInvalidDataToken(),void callback(!1)):void $http({method:"POST",url:"https://opengarage.io/wp-admin/admin-ajax.php",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},data:$httpParamSerializerJQLike({action:"getSites",token:local.cloudToken,controllerType:"opengarage"})}).then(function(result){if(result.data.success===!1||""===result.data.sites)"BAD_TOKEN"===result.data.message&&handleExpiredLogin(),callback(!1,result.data.message);else{Utils.storage.set({cloudToken:result.data.token});var sites;try{sites=sjcl.decrypt(local.cloudDataToken,result.data.sites)}catch(err){"ccm: tag doesn't match"===err.message&&handleInvalidDataToken(),callback(!1)}try{callback(JSON.parse(sites))}catch(err){callback(!1)}}},function(){callback(!1)})})},saveSites=function(callback){"function"!=typeof callback&&(callback=function(){}),$http=$http||$injector.get("$http"),$httpParamSerializerJQLike=$httpParamSerializerJQLike||$injector.get("$httpParamSerializerJQLike"),Utils.storage.get(["cloudToken","cloudDataToken"],function(data){return null===data.cloudToken||void 0===data.cloudToken?void callback(!1):void $http({method:"POST",url:"https://opengarage.io/wp-admin/admin-ajax.php",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},data:$httpParamSerializerJQLike({action:"saveSites",token:data.cloudToken,controllerType:"opengarage",sites:encodeURIComponent(JSON.stringify(sjcl.encrypt(data.cloudDataToken,JSON.stringify($rootScope.controllers))))})}).then(function(result){result.data.success===!1?("BAD_TOKEN"===result.data.message&&handleExpiredLogin(),callback(!1,result.data.message)):(Utils.storage.set({cloudToken:result.data.token}),callback(result.data.success))},function(){callback(!1)})})},handleInvalidDataToken=function(){Utils.storage.remove("cloudDataToken"),$ionicPopup=$ionicPopup||$injector.get("$ionicPopup"),$ionicPopup.prompt({title:"Unable to read cloud data",subTitle:"Enter a valid password to decrypt the data",template:"Please enter your OpenSprinkler.com password. If you have recently changed your password, you may need to enter your previous password to decrypt the data.",inputType:"password",inputPlaceholder:"Password"}).then(function(password){Utils.storage.set({cloudDataToken:sjcl.codec.hex.fromBits(sjcl.hash.sha256.hash(password))}),sync()})},handleExpiredLogin=function(){Utils.storage.remove("cloudToken"),$ionicPopup=$ionicPopup||$injector.get("$ionicPopup"),$ionicPopup.confirm({title:"OpenGarage.io Login Expired",template:"Click here to re-login to OpenGarage.io"}).then(function(result){result&&requestAuth(function(result){result===!0&&sync()})})},getTokenUser=function(token){return atob(token).split("|")[0]};return Utils.storage.get(["cloudToken","cloudDataToken"],function(data){null===data.cloudToken||void 0===data.cloudToken||void 0===data.cloudDataToken||void 0===data.cloudDataToken?$rootScope.isSynced=!1:$rootScope.isSynced=!0}),$rootScope.$on("triggerCloudSave",saveSites),{requestAuth:requestAuth,login:login,logout:logout,syncStart:syncStart,sync:sync,getSites:getSites,saveSites:saveSites,handleInvalidDataToken:handleInvalidDataToken,handleExpiredLogin:handleExpiredLogin,getTokenUser:getTokenUser}}]),angular.module("opengarage.controllers",["opengarage.utils","opengarage.cloud"]).controller("ControllerSelectCtrl",function($scope,$state,$rootScope,$timeout,$filter,$ionicModal,$ionicHistory,Utils,Cloud){$scope.data={showDelete:!1,image:!1,cropped:!1,index:!1};var fileInput=angular.element(document.getElementById("photoUpload"));$ionicModal.fromTemplateUrl("templates/crop.html",{scope:$scope}).then(function(modal){$scope.crop=modal}),$scope.hasCamera=!(!navigator.camera||!navigator.camera.getPicture),$scope.setController=function(index){$rootScope.activeController=$rootScope.controllers[index],$rootScope.connected=!1,Utils.updateController(),Utils.storage.set({activeController:JSON.stringify($rootScope.activeController)}),$ionicHistory.nextViewOptions({historyRoot:!0}),$state.go("app.home")},$scope.deleteController=function(index){$rootScope.controllers.indexOf(($filter("filter")($rootScope.controllers,{mac:$rootScope.activeController.mac})||[])[0])===index&&(delete $rootScope.activeController,Utils.storage.remove("activeController")),$rootScope.controllers.splice(index,1),Utils.storage.set({controllers:JSON.stringify($rootScope.controllers)}),Cloud.saveSites()},$scope.moveItem=function(item,fromIndex,toIndex){$rootScope.controllers.splice(fromIndex,1),$rootScope.controllers.splice(toIndex,0,item),Utils.storage.set({controllers:JSON.stringify($rootScope.controllers)}),Cloud.saveSites()},$scope.getTime=function(timestamp){return new Date(timestamp).toLocaleString()},$scope.selectPhoto=function($event,index){return $event.stopPropagation(),$scope.data.showDelete?($rootScope.controllers.indexOf(($filter("filter")($rootScope.controllers,{mac:$rootScope.activeController.mac})||[])[0])===index&&(delete $rootScope.activeController.image,Utils.storage.set({activeController:JSON.stringify($rootScope.activeController)})),delete $rootScope.controllers[index].image,Utils.storage.set({controllers:JSON.stringify($rootScope.controllers)}),Cloud.saveSites(),void $timeout(function(){$scope.$apply()})):(fileInput.parent()[0].reset(),fileInput.one("change",function(){var file=fileInput[0].files[0];if(file.type&&file.type.match("image.*")){var reader=new FileReader;reader.onload=function(evt){$scope.data.image=evt.target.result,$scope.data.index=index,$scope.crop.show()},reader.readAsDataURL(file)}}),void fileInput[0].click())},$scope.uploadPhoto=function(index){$scope.crop.hide(),$rootScope.controllers.indexOf(($filter("filter")($rootScope.controllers,{mac:$rootScope.activeController.mac})||[])[0])===index&&($rootScope.activeController.image=$scope.data.cropped,Utils.storage.set({activeController:JSON.stringify($rootScope.activeController)})),$rootScope.controllers[index].image=$scope.data.cropped,Utils.storage.set({controllers:JSON.stringify($rootScope.controllers)}),Cloud.saveSites(),$timeout(function(){$scope.$apply()})},$scope.changeSync=function(){$rootScope.isSynced?Cloud.logout():Cloud.requestAuth()}}).controller("HistoryCtrl",function($scope,Utils){$scope.$on("$ionicView.beforeEnter",function(){Utils.getLogs(function(reply){reply?($scope.isLocal=!0,$scope.logs=reply):$scope.isLocal=!1})})}).controller("SettingsCtrl",function($scope,$state,$ionicPopup,Utils){$scope.settings={},$scope.changePassword=Utils.changePassword,$scope.restart=Utils.restartController,$scope.submit=function(){Utils.saveOptions($scope.settings,function(reply){var text;reply?(text="Settings saved successfully!",$state.go("app.home")):text="Unable to save settings. Please check the connection to the device and try again.",$ionicPopup.alert({template:"<p class='center'>"+text+"</p>"})})},$scope.$on("$ionicView.beforeEnter",function(){Utils.getControllerOptions(function(reply){reply?($scope.isLocal=!0,delete reply.mod,delete reply.fwv,$scope.settings=reply):$scope.isLocal=!1},null,!0)})}).controller("MenuCtrl",function($scope,$rootScope,$ionicActionSheet,$ionicPopup,$ionicSideMenuDelegate,Utils){$scope.showAddController=function(){$ionicActionSheet.show({buttons:[{text:"Add by IP"},{text:"Add by Blynk Token"},{text:"Setup New Device"}],titleText:"Add Controller",cancelText:"Cancel",buttonClicked:function(index){return 1===index?Utils.showAddBlynk():0===index?Utils.showAddController():($rootScope.$broadcast("loading:show"),Utils.checkNewController(function(result){$rootScope.$broadcast("loading:hide"),result||$ionicPopup.alert({template:"<p class='center'>Please first connect the power to your OpenGarage. Once complete, connect this device to the wifi network broadcast by the OpenGarage (named OG_XXXXXX) and reopen this app.</p>"})})),!0}})},$scope.closeMenu=function(){$ionicSideMenuDelegate.toggleLeft(!1)}}).controller("HomeCtrl",function($rootScope,$scope,$timeout,Utils){var interval;$scope.toggleDoor=Utils.toggleDoor,$scope.$on("$ionicView.beforeLeave",function(){clearInterval(interval)}),$scope.$on("$ionicView.beforeEnter",function(){interval=setInterval(Utils.updateController,3e3)}),$rootScope.$on("controllerUpdated",function(){$timeout(function(){$scope.$apply()})})}),angular.module("opengarage.utils",[]).factory("Utils",["$injector","$rootScope",function($injector,$rootScope){var $http,$q,$filter,$ionicPopup,$ionicModal,isFireFox=/Firefox/.test(window.navigator.userAgent),isIE=/MSIE\s|Trident\/|Edge\//.test(window.navigator.userAgent),storage={get:function(query,callback){callback=callback||function(){};var i,data={};"string"==typeof query&&(query=[query]);for(i in query)query.hasOwnProperty(i)&&(data[query[i]]=localStorage.getItem(query[i]));callback(data)},set:function(query,callback){callback=callback||function(){};var i;if("object"==typeof query)for(i in query)query.hasOwnProperty(i)&&localStorage.setItem(i,query[i]);callback(!0)},remove:function(query,callback){callback=callback||function(){};var i;"string"==typeof query&&(query=[query]);for(i in query)query.hasOwnProperty(i)&&localStorage.removeItem(query[i]);callback(!0)}},intToIP=function(int){return int%256+"."+(int/256>>0)%256+"."+((int/256>>0)/256>>0)%256+"."+(((int/256>>0)/256>>0)/256>>0)},getControllerSettings=function(callback,ip,token){if(!ip&&!token&&!$rootScope.activeController)return void callback(!1);$http=$http||$injector.get("$http");var promise;return promise=$http(token||!ip&&$rootScope.activeController&&$rootScope.activeController.auth?{method:"POST",url:"https://opengarage.io/wp-admin/admin-ajax.php",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},data:"action=blynkCloud&path="+encodeURIComponent(token||$rootScope.activeController.auth)+"/query",suppressLoader:!0}:{method:"GET",url:"http://"+(ip||$rootScope.activeController.ip)+"/jc",suppressLoader:!ip}),promise.then(function(result){if(token||!ip&&$rootScope.activeController&&$rootScope.activeController.auth){$filter=$filter||$injector.get("$filter");var filter=$filter("filter");result=result.data[0],callback({name:result.name,door:parseInt(filter(result.pins,{pin:0})[0].value),dist:parseInt(filter(result.pins,{pin:3})[0].value),rcnt:parseInt(filter(result.pins,{pin:4})[0].value),lastUpdate:(new Date).getTime()})}else result.data.lastUpdate=(new Date).getTime(),callback(result.data)},function(){callback(!1)})},getControllerOptions=function(callback,ip,showLoader){return!ip&&!$rootScope.activeController||$rootScope.activeController&&!$rootScope.activeController.ip?void callback(!1):($http=$http||$injector.get("$http"),$http({method:"GET",url:"http://"+(ip||$rootScope.activeController.ip)+"/jo",suppressLoader:!showLoader}).then(function(result){callback(result.data)},function(){callback(!1)}))},updateController=function(){$q=$q||$injector.get("$q"),$filter=$filter||$injector.get("$filter");var controller=angular.copy($rootScope.activeController),save=function(data){$rootScope.connected=!0,angular.extend(controller,data)};$q.when().then(function(){return getControllerSettings(save)}).then(function(){return getControllerOptions(save)}).then(function(){var index=$rootScope.controllers.indexOf(($filter("filter")($rootScope.controllers,{mac:controller.mac})||[])[0]);index>=0&&($rootScope.controllers[index]=controller,$rootScope.activeController=controller,$rootScope.$broadcast("controllerUpdated"),storage.set({controllers:JSON.stringify($rootScope.controllers),activeController:JSON.stringify($rootScope.activeController)}))})},addController=function(data,callback){return callback=callback||function(){},$ionicPopup=$ionicPopup||$injector.get("$ionicPopup"),data.token||data.ip&&data.password?data.token&&32!==data.token.length?($ionicPopup.alert({template:"<p class='center'>A valid Blynk token is required. Please verify your token and try again.</p>"}),void callback(!1)):void getControllerSettings(function(result){if(result||($ionicPopup.alert({template:"<p class='center'>Unable to find device. Please verify the IP/password and try again.</p>"}),callback(!1)),result.mac){if(result.ip=data.ip,result.password=data.password,$filter=$filter||$injector.get("$filter"),$filter("filter")($rootScope.controllers,{mac:result.mac}).length>0)return $ionicPopup.alert({template:"<p class='center'>Device already added to site list.</p>"}),void callback(!1);getControllerOptions(function(reply){angular.extend(result,reply),$rootScope.controllers.push(result),storage.set({controllers:JSON.stringify($rootScope.controllers)}),$rootScope.$broadcast("triggerCloudSave"),callback(!0)},data.ip)}data.token&&$http({method:"POST",url:"https://openthings.io/wp-admin/admin-ajax.php",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},data:"action=blynkCloud&path="+data.token+"/get/V2",suppressLoader:!0}).then(function(reply){return reply=reply.data.pop().split(" ")[1].split("_")[1],result.mac="5C:CF:7F"+reply.match(/.{1,2}/g).join(":"),result.auth=data.token,$filter("filter")($rootScope.controllers,{mac:result.mac}).length>0?($ionicPopup.alert({template:"<p class='center'>Device already added to site list.</p>"}),void callback(!1)):($rootScope.controllers.push(result),storage.set({controllers:JSON.stringify($rootScope.controllers)}),$rootScope.$broadcast("triggerCloudSave"),void callback(!0))})},data.token?null:data.ip,data.token?data.token:null):($ionicPopup.alert({template:"<p class='center'>Both an IP and password are required.</p>"}),void callback(!1))},checkNewController=function(callback){$http=$http||$injector.get("$http"),callback=callback||function(){},$ionicModal=$ionicModal||$injector.get("$ionicModal"),$http({method:"GET",url:"http://192.168.4.1/js",suppressLoader:!0,timeout:5e3,config:{retryCount:0}}).then(function(result){if(!result.data.ssids)return void callback(!1);var scope=$rootScope.$new();scope.data={},scope.save=function(){scope.modal.hide(),connectNewController(scope.data)},scope.ssids=result.data.ssids,$ionicModal.fromTemplateUrl("templates/newControllerSetup.html",{scope:scope,animation:"slide-in-up"}).then(function(modal){scope.modal=modal,modal.show()}),callback(!0)},function(){callback(!1)})},connectNewController=function(data){$http=$http||$injector.get("$http"),$ionicPopup=$ionicPopup||$injector.get("$ionicPopup"),$http({method:"GET",url:"http://192.168.4.1/cc?ssid="+encodeURIComponent(data.ssid)+"&pass="+encodeURIComponent(data.password)}).then(function(result){1===result.data.result?setTimeout(saveNewController,2e3):$ionicPopup.alert({template:"<p class='center'>Invalid SSID/password combination. Please try again.</p>"}).then(checkNewController)},function(){$ionicPopup.alert({template:"<p class='center'>Unable to reach controller. Please try again.</p>"}).then(checkNewController)})},saveNewController=function(){$http=$http||$injector.get("$http"),$ionicPopup=$ionicPopup||$injector.get("$ionicPopup"),$http({method:"GET",url:"http://192.168.4.1/jt"}).then(function(result){return 0===result.data.ip?void $ionicPopup.alert({template:"<p class='center'>Controller was unable to connect. Please check your SSID and password and try again.</p>"}):($ionicPopup.alert({template:"<p class='center'>Controller succesfully connected! Please wait while the device reboots.</p>"}),$rootScope.controllers.push({ip:intToIP(result.data.ip),password:"opendoor",name:"My OpenGarage"}),storage.set({controllers:JSON.stringify($rootScope.controllers)}),void $rootScope.$broadcast("triggerCloudSave"))})},scanLocalNetwork=function(callback){return window.networkinterface?void window.networkinterface.getIPAddress(function(router){if(!router)return void callback(!1);$q=$q||$injector.get("$q"),$http=$http||$injector.get("$http"),router=router.split("."),router.pop();var i,baseip=router.join("."),check=function(ip){return $http({method:"GET",url:"http://"+baseip+"."+ip+"/jc",suppressLoader:!0,timeout:6e3,config:{retryCount:0}}).then(function(result){result.data&&result.data.mac&&matches.push(baseip+"."+ip)})["catch"](function(){return!1})},queue=[],matches=[];for($rootScope.$broadcast("loading:show"),i=1;i<=244;i++)queue.push(check(i));$q.all(queue).then(function(){$rootScope.$broadcast("loading:hide"),callback(matches)})}):void callback(!1)},requestPassword=function(callback){$ionicPopup=$ionicPopup||$injector.get("$ionicPopup"),$ionicPopup.prompt({title:"Enter Controller Password",template:"Enter your controller's password below:",inputType:"password",inputPlaceholder:"Controller Password"}).then(function(password){callback(password)})};return isFireFox&&(HTMLElement.prototype.click=function(){var evt=this.ownerDocument.createEvent("MouseEvents");evt.initMouseEvent("click",!0,!0,this.ownerDocument.defaultView,1,0,0,0,0,!1,!1,!1,!1,0,null),this.dispatchEvent(evt)}),{isIE:isIE,storage:storage,getControllerSettings:getControllerSettings,getControllerOptions:getControllerOptions,updateController:updateController,checkNewController:checkNewController,showAddController:function(callback){callback=callback||function(){},$ionicPopup=$ionicPopup||$injector.get("$ionicPopup");var scope=$rootScope.$new();scope.data={canScan:!!window.networkinterface},scope.scan=function(){scanLocalNetwork(function(result){return result&&result.length?void(scope.data.foundControllers=result):void $ionicPopup.alert({template:"<p class='center'>No devices detected on your network</p>"})})},scope.save=function(ip){popup.close(),requestPassword(function(password){addController({ip:ip,password:password})})};var popup=$ionicPopup.show({templateUrl:"templates/addController.html",title:"Add Controller",scope:scope,buttons:[{text:"Cancel"},{text:"<b>Add</b>",type:"button-positive",onTap:function(e){return!(!scope.data.ip||!scope.data.password)||void e.preventDefault()}}]});popup.then(function(isValid){isValid&&addController(scope.data,callback)})},showAddBlynk:function(callback){callback=callback||function(){},$ionicPopup=$ionicPopup||$injector.get("$ionicPopup"),$ionicPopup.prompt({title:"Add Controller by Blynk",template:"Enter your Blynk Auth token below:",inputType:"text",inputPlaceholder:"Your Blynk Auth token"}).then(function(token){token&&addController({token:token},callback)})},toggleDoor:function(callback){callback=callback||function(){},$http=$http||$injector.get("$http");var promise;$rootScope.activeController&&$rootScope.activeController.auth?($rootScope.$broadcast("loading:show"),promise=$http({method:"POST",url:"https://openthings.io/wp-admin/admin-ajax.php",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},data:"action=blynkCloud&path="+encodeURIComponent($rootScope.activeController.auth+"/update/V1?value=1"),suppressLoader:!0}).then(function(){setTimeout(function(){$http({method:"POST",url:"https://openthings.io/wp-admin/admin-ajax.php",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},data:"action=blynkCloud&path="+encodeURIComponent($rootScope.activeController.auth+"/update/V1?value=0"),suppressLoader:!0}).then(function(){$rootScope.$broadcast("loading:hide")})},1e3)})):promise=$http.get("http://"+$rootScope.activeController.ip+"/cc?dkey="+encodeURIComponent($rootScope.activeController.password)+"&click=1"),promise.then(function(){callback(!0)},function(){callback(!1)})},restartController:function(){$http=$http||$injector.get("$http"),$ionicPopup=$ionicPopup||$injector.get("$ionicPopup"),$rootScope.activeController&&$ionicPopup.confirm({title:"Restart Controller?",template:"<p class='center'>Are you sure you want to restart the controller?</p>"}).then(function(result){result&&$http.get("http://"+$rootScope.activeController.ip+"/cc?dkey="+encodeURIComponent($rootScope.activeController.password)+"&reboot=1")})},saveOptions:function(settings,callback){return $http=$http||$injector.get("$http"),$http({method:"GET",url:"http://"+$rootScope.activeController.ip+"/co?dkey="+$rootScope.activeController.password,params:settings,paramSerializer:"$httpParamSerializerJQLike"}).then(function(result){callback(result.data)},function(){callback(!1)})},changePassword:function(){$ionicPopup=$ionicPopup||$injector.get("$ionicPopup");var scope=$rootScope.$new();scope.pwd={},$ionicPopup.show({templateUrl:"templates/changePassword.html",title:"Change Password",scope:scope,buttons:[{text:"Cancel"},{text:"<b>Go</b>",type:"button-positive"}]}).then(function(){scope.pwd.nkey&&scope.pwd.ckey&&scope.pwd.nkey===scope.pwd.ckey&&($http=$http||$injector.get("$http"),$http({method:"GET",url:"http://"+$rootScope.activeController.ip+"/co?dkey="+$rootScope.activeController.password,params:scope.pwd,paramSerializer:"$httpParamSerializerJQLike"}).then(function(){$rootScope.activeController.password=scope.pwd.nkey;var index=$rootScope.controllers.indexOf(($filter("filter")($rootScope.controllers,{mac:$rootScope.activeController.mac})||[])[0]);index&&($rootScope.controllers[index]=$rootScope.activeController,storage.set({controllers:JSON.stringify($rootScope.controllers),activeController:JSON.stringify($rootScope.activeController)}),$rootScope.$broadcast("triggerCloudSave")),$ionicPopup.alert({template:"<p class='center'>Password updated succesfully!</p>"})}))})},getLogs:function(callback){return $rootScope.activeController&&$rootScope.activeController.ip?($http=$http||$injector.get("$http"),void $http({method:"GET",url:"http://"+$rootScope.activeController.ip+"/jl"}).then(function(result){callback(result.data.logs.sort(function(a,b){return b[0]-a[0]}))},function(){callback(!1)})):void callback(!1)}}}]);
//# sourceMappingURL=app.min.js.map
